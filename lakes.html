<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FisherMN - Lakes Map</title>
  <link rel="stylesheet" href="/public/css/tailwind.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="/public/js/navigation.js"></script>
  <script src="/public/js/auth.js"></script>
  <script src="/public/js/ui-controller.js"></script>
  <script src="/public/js/auth-modal.js"></script>
  <style>
    #map {
      height: calc(100vh - 64px);
      width: 100%;
      position: relative;
      z-index: 0;
    }
    /* Ensure Leaflet controls don't exceed modal z-index */
    .leaflet-pane,
    .leaflet-control {
      z-index: 1 !important;
    }
    .leaflet-top,
    .leaflet-bottom {
      z-index: 10 !important;
    }
    .lake-list-item {
      cursor: pointer;
      transition: all 0.2s;
    }
    .lake-list-item:hover {
      transform: translateX(4px);
    }
    .lake-list-item.active {
      border-left: 4px solid #D4AF37;
      background-color: #F4F9FC;
    }
    #lakes-list {
      overflow-y: auto;
      min-height: 0;
    }
  </style>
</head>
<body class="bg-frost overflow-hidden">
  <!-- Auth Modal Loader -->
  <div hx-get="/public/partials/auth-modal.html" hx-trigger="load" hx-swap="beforeend"></div>

  <!-- Left Sidebar - Auth-aware loading -->
  <div id="sidebar-container">
    <aside class="fixed left-0 top-0 h-screen w-64 bg-primary"></aside>
  </div>
  <script>
    (function() {
      var isLoggedIn = !!localStorage.getItem('fishermn_auth_token');
      var url = isLoggedIn ? '/public/partials/sidebar-user.html' : '/public/partials/sidebar-guest.html';
      var el = document.getElementById('sidebar-container');
      el.setAttribute('hx-get', url);
      el.setAttribute('hx-trigger', 'load');
      el.setAttribute('hx-swap', 'outerHTML');
    })();
  </script>

  <!-- Top Bar -->
  <div hx-get="/public/partials/top-bar.html" hx-trigger="load" hx-swap="outerHTML"></div>

  <!-- Main Content Area -->
  <main class="ml-64 mt-16 flex h-[calc(100vh-64px)]">
    <!-- Left Panel: Lakes List -->
    <div class="w-[480px] bg-white border-r border-grayPanel flex flex-col h-[calc(100vh-64px)]">
      <div class="px-6 py-3 border-b border-grayPanel bg-white flex-shrink-0">
        <input
          type="text"
          id="lake-search"
          placeholder="Search lakes..."
          class="w-full px-4 py-2 text-sm rounded-lg border border-grayPanel focus:outline-none focus:ring-2 focus:ring-primary"
          onkeyup="filterLakes()"
        >

        <!-- Ice Thickness Filter -->
        <div class="mt-4 space-y-1">
          <label class="text-xs font-semibold text-secondary">Ice Thickness</label>
          <select id="filter-condition" onchange="applyFilters()" class="w-full px-3 py-2 text-sm rounded-lg border border-grayPanel focus:outline-none focus:ring-2 focus:ring-primary bg-white">
            <option value="">All</option>
            <option value="4">ðŸŸ  4 inches â€“ Single person on foot</option>
            <option value="6">ðŸŸ¡ 6 inches â€“ ATVs and light gear</option>
            <option value="8">ðŸŸ¡ 8 inches â€“ Snowmobiles and small shelters</option>
            <option value="10">ðŸŸ¡ 10 inches â€“ Small cars or heavier setups</option>
            <option value="12">ðŸŸ¢ 12 inches â€“ Light trucks and larger shelters</option>
            <option value="14">ðŸŸ¢ 14 inches â€“ Most pickup trucks</option>
            <option value="16">ðŸŸ¢ 16 inches â€“ Heavy trucks and ice roads</option>
            <option value="18">ðŸŸ¢ 18 inches â€“ Heavy equipment and maximum stability</option>
          </select>
        </div>

        <!-- Filters -->
        <div class="mt-4 bg-white border border-grayPanel rounded-lg overflow-hidden">
          <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-frost transition-colors" onclick="toggleFilters()">
            <div class="flex items-center gap-2">
              <span class="text-xs font-semibold text-secondary">Filters</span>
              <span id="filter-count" class="hidden text-xs bg-gold text-white px-2 py-0.5 rounded-full"></span>
            </div>
            <svg id="filter-chevron" class="w-3 h-3 text-secondary transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          <div id="filter-content" class="hidden">
            <div class="p-3 pt-0 space-y-3">
              <!-- Bar Counter Filter -->
              <div class="space-y-1">
                <label class="text-xs font-semibold text-secondary">Bars</label>
                <div class="flex items-center gap-3">
                  <button id="bars-minus" onclick="adjustBarCounter(-1)" class="w-8 h-8 flex items-center justify-center rounded border border-grayPanel bg-white hover:bg-frost text-secondary font-bold disabled:opacity-40 disabled:cursor-not-allowed" disabled>âˆ’</button>
                  <div class="flex items-center gap-2">
                    <span id="bars-count" class="text-lg font-bold text-primary">0</span>
                    <span id="bars-label" class="text-xs text-secondary hidden">or more</span>
                  </div>
                  <button id="bars-plus" onclick="adjustBarCounter(1)" class="w-8 h-8 flex items-center justify-center rounded border border-grayPanel bg-white hover:bg-frost text-secondary font-bold">+</button>
                </div>
              </div>

              <!-- Amenity Checkboxes -->
              <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-casino" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Casino</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-baitshop" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Bait Shop</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-icehouse" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Ice House Rental</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-lodging" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Lodging</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-restaurant" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Restaurant</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-boatlaunch" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Boat Launch</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-gasstation" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Gas Station</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-grocery" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Grocery</span>
                </label>
                <label class="flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="filter-guideservice" onchange="applyFilters()" class="w-4 h-4 rounded border-grayPanel text-primary focus:ring-primary">
                  <span>Guide Service</span>
                </label>
              </div>

              <button onclick="clearFilters()" class="text-xs text-primary hover:underline">Clear all filters</button>
            </div>
          </div>
        </div>

      </div>

      <div id="lakes-list" class="p-6 space-y-3 overflow-y-auto flex-1 min-h-0">
        <!-- Upper Red Lake -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-1', 48.0635, -94.8797)" data-lake-name="Upper Red Lake" data-condition="Excellent" data-thickness="14" data-casino="false" data-bars="3" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="true" data-grocery="true" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Upper Red Lake</h3>
            <span class="badge bg-evergreen text-white text-xs px-3 py-1">14"</span>
          </div>
          <p class="text-xs text-secondary">Northern Minnesota</p>
        </div>

        <!-- Lake of the Woods -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-2', 49.0, -94.6)" data-lake-name="Lake of the Woods" data-condition="Excellent" data-thickness="16" data-casino="true" data-bars="4" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="true" data-grocery="true" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Lake of the Woods</h3>
            <span class="badge bg-evergreen text-white text-xs px-3 py-1">16"</span>
          </div>
          <p class="text-xs text-secondary">Northern Minnesota</p>
        </div>

        <!-- Mille Lacs Lake -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-3', 46.2633, -93.6578)" data-lake-name="Mille Lacs Lake" data-condition="Good" data-thickness="10" data-casino="true" data-bars="4" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="true" data-grocery="true" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Mille Lacs Lake</h3>
            <span class="badge bg-gold text-white text-xs px-3 py-1">10"</span>
          </div>
          <p class="text-xs text-secondary">Central Minnesota</p>
        </div>

        <!-- Leech Lake -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-4', 47.2158, -94.4194)" data-lake-name="Leech Lake" data-condition="Excellent" data-thickness="13" data-casino="true" data-bars="3" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="true" data-grocery="false" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Leech Lake</h3>
            <span class="badge bg-evergreen text-white text-xs px-3 py-1">13"</span>
          </div>
          <p class="text-xs text-secondary">North Central Minnesota</p>
        </div>

        <!-- Lake Winnibigoshish -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-5', 47.4417, -94.1575)" data-lake-name="Lake Winnibigoshish" data-condition="Excellent" data-thickness="15" data-casino="false" data-bars="2" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="false" data-boatlaunch="true" data-gasstation="false" data-grocery="false" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Lake Winnibigoshish</h3>
            <span class="badge bg-evergreen text-white text-xs px-3 py-1">15"</span>
          </div>
          <p class="text-xs text-secondary">North Central Minnesota</p>
        </div>

        <!-- Lake Vermilion -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-6', 47.9356, -92.3375)" data-lake-name="Lake Vermilion" data-condition="Good" data-thickness="11" data-casino="true" data-bars="2" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="false" data-grocery="false" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Lake Vermilion</h3>
            <span class="badge bg-gold text-white text-xs px-3 py-1">11"</span>
          </div>
          <p class="text-xs text-secondary">Northern Minnesota</p>
        </div>

        <!-- Gull Lake -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-7', 46.4069, -94.3553)" data-lake-name="Gull Lake" data-condition="Fair" data-thickness="8" data-casino="false" data-bars="3" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="true" data-grocery="true" data-guideservice="false">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Gull Lake</h3>
            <span class="badge bg-gold text-white text-xs px-3 py-1">8"</span>
          </div>
          <p class="text-xs text-secondary">Brainerd Lakes</p>
        </div>

        <!-- Rainy Lake -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-8', 48.6167, -93.3808)" data-lake-name="Rainy Lake" data-condition="Excellent" data-thickness="17" data-casino="false" data-bars="2" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="false" data-boatlaunch="true" data-gasstation="true" data-grocery="false" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Rainy Lake</h3>
            <span class="badge bg-evergreen text-white text-xs px-3 py-1">17"</span>
          </div>
          <p class="text-xs text-secondary">International Falls</p>
        </div>

        <!-- Otter Tail Lake -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-9', 46.4236, -95.6978)" data-lake-name="Otter Tail Lake" data-condition="Good" data-thickness="9" data-casino="false" data-bars="2" data-resort="true" data-baitshop="true" data-icehouse="false" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="false" data-grocery="true" data-guideservice="false">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Otter Tail Lake</h3>
            <span class="badge bg-gold text-white text-xs px-3 py-1">9"</span>
          </div>
          <p class="text-xs text-secondary">West Central Minnesota</p>
        </div>

        <!-- Cass Lake -->
        <div class="lake-list-item card py-3 px-4" onclick="flyToLake('lake-10', 47.3919, -94.6050)" data-lake-name="Cass Lake" data-condition="Excellent" data-thickness="12" data-casino="true" data-bars="2" data-resort="true" data-baitshop="true" data-icehouse="true" data-lodging="true" data-restaurant="true" data-boatlaunch="true" data-gasstation="false" data-grocery="false" data-guideservice="true">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-base">Cass Lake</h3>
            <span class="badge bg-evergreen text-white text-xs px-3 py-1">12"</span>
          </div>
          <p class="text-xs text-secondary">North Central Minnesota</p>
        </div>
      </div>
    </div>

    <!-- Right Panel: Interactive Map -->
    <div class="flex-1">
      <div id="map"></div>
    </div>
  </main>

  <script>
    // Initialize map centered on Minnesota
    const map = L.map('map').setView([46.5, -94.0], 7);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 18,
      minZoom: 6
    }).addTo(map);

    // Lake data with coordinates
    const lakes = [
      { id: 'lake-1', slug: 'upper-red-lake', name: 'Upper Red Lake', lat: 48.0635, lon: -94.8797, condition: 'excellent', thickness: 14, bars: 3, casino: false, baitshop: true, icehouse: true, lodging: true, restaurant: true, boatlaunch: true, gasstation: true, grocery: true, guideservice: true },
      { id: 'lake-2', slug: 'lake-of-the-woods', name: 'Lake of the Woods', lat: 49.0, lon: -94.6, condition: 'excellent', thickness: 16, bars: 4, casino: true, baitshop: true, icehouse: true, lodging: true, restaurant: true, boatlaunch: true, gasstation: true, grocery: true, guideservice: true },
      { id: 'lake-3', slug: 'mille-lacs', name: 'Mille Lacs Lake', lat: 46.2633, lon: -93.6578, condition: 'good', thickness: 10, bars: 4, casino: true, baitshop: true, icehouse: true, lodging: true, restaurant: true, boatlaunch: true, gasstation: true, grocery: true, guideservice: true },
      { id: 'lake-4', slug: 'leech-lake', name: 'Leech Lake', lat: 47.2158, lon: -94.4194, condition: 'excellent', thickness: 13, bars: 3, casino: true, baitshop: true, icehouse: true, lodging: true, restaurant: true, boatlaunch: true, gasstation: true, grocery: false, guideservice: true },
      { id: 'lake-5', slug: 'winnibigoshish', name: 'Lake Winnibigoshish', lat: 47.4417, lon: -94.1575, condition: 'excellent', thickness: 15, bars: 2, casino: false, baitshop: true, icehouse: true, lodging: true, restaurant: false, boatlaunch: true, gasstation: false, grocery: false, guideservice: true },
      { id: 'lake-6', slug: 'vermilion', name: 'Lake Vermilion', lat: 47.9356, lon: -92.3375, condition: 'good', thickness: 11, bars: 2, casino: true, baitshop: true, icehouse: true, lodging: true, restaurant: true, boatlaunch: true, gasstation: false, grocery: false, guideservice: true },
      { id: 'lake-7', slug: 'gull-lake', name: 'Gull Lake', lat: 46.4069, lon: -94.3553, condition: 'fair', thickness: 8, bars: 3, casino: false, baitshop: true, icehouse: true, lodging: true, restaurant: true, boatlaunch: true, gasstation: true, grocery: true, guideservice: false },
      { id: 'lake-8', slug: 'rainy-lake', name: 'Rainy Lake', lat: 48.6167, lon: -93.3808, condition: 'excellent', thickness: 17, bars: 2, casino: false, baitshop: true, icehouse: true, lodging: true, restaurant: false, boatlaunch: true, gasstation: true, grocery: false, guideservice: true },
      { id: 'lake-9', slug: 'otter-tail', name: 'Otter Tail Lake', lat: 46.4236, lon: -95.6978, condition: 'good', thickness: 9, bars: 2, casino: false, baitshop: true, icehouse: false, lodging: true, restaurant: true, boatlaunch: true, gasstation: false, grocery: true, guideservice: false },
      { id: 'lake-10', slug: 'cass-lake', name: 'Cass Lake', lat: 47.3919, lon: -94.6050, condition: 'excellent', thickness: 12, bars: 2, casino: true, baitshop: true, icehouse: true, lodging: true, restaurant: true, boatlaunch: true, gasstation: false, grocery: false, guideservice: true }
    ];

    // Function to get color based on ice thickness
    function getThicknessColor(thickness) {
      if (thickness < 4) return null; // Don't show
      if (thickness < 6) return '#FF8C00'; // Orange
      if (thickness < 12) return '#D4AF37'; // Yellow/Gold
      return '#22C55E'; // Bright Green
    }

    // Add markers for each lake
    lakes.forEach(lake => {
      // Skip lakes with less than 4 inches of ice
      if (lake.thickness < 4) return;

      const markerColor = getThicknessColor(lake.thickness);

      // Create custom icon
      const customIcon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="background-color: ${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      const marker = L.marker([lake.lat, lake.lon], { icon: customIcon })
        .addTo(map)
        .bindPopup(`
          <div style="min-width: 200px;">
            <h3 style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">${lake.name}</h3>
            <p style="font-size: 12px; color: #4B5563; margin-bottom: 8px;">
              <strong>Ice Thickness:</strong> ${lake.thickness}"<br>
              <strong>Condition:</strong> ${lake.condition.charAt(0).toUpperCase() + lake.condition.slice(1)}
            </p>
            <a
              href="/lake.html?id=${lake.slug}"
              style="display: block; background-color: #0A3A60; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; width: 100%; text-align: center; text-decoration: none;">
              Lake Page
            </a>
          </div>
        `);

      // Store marker reference
      lake.marker = marker;
    });

    // Function to toggle filters visibility
    function toggleFilters() {
      const filterContent = document.getElementById('filter-content');
      const chevron = document.getElementById('filter-chevron');

      if (filterContent.classList.contains('hidden')) {
        filterContent.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
      } else {
        filterContent.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    // Function to adjust bar counter
    function adjustBarCounter(delta) {
      const countElement = document.getElementById('bars-count');
      const labelElement = document.getElementById('bars-label');
      const minusButton = document.getElementById('bars-minus');
      let currentCount = parseInt(countElement.textContent) || 0;

      // Update count
      currentCount = Math.max(0, Math.min(10, currentCount + delta));
      countElement.textContent = currentCount;

      // Show/hide "or more" label
      if (currentCount > 0) {
        labelElement.classList.remove('hidden');
      } else {
        labelElement.classList.add('hidden');
      }

      // Enable/disable minus button
      if (currentCount === 0) {
        minusButton.disabled = true;
      } else {
        minusButton.disabled = false;
      }

      // Apply filters
      applyFilters();
    }

    // Function to fly to a lake and highlight it
    function flyToLake(lakeId, lat, lon) {
      // Remove active class from all items
      document.querySelectorAll('.lake-list-item').forEach(item => {
        item.classList.remove('active');
      });

      // Add active class to clicked item
      event.currentTarget.classList.add('active');

      // Fly to location and zoom in
      map.flyTo([lat, lon], 10, {
        duration: 1.5,
        easeLinearity: 0.5
      });

      // Open popup for the lake
      const lake = lakes.find(l => l.id === lakeId);
      if (lake && lake.marker) {
        setTimeout(() => {
          lake.marker.openPopup();
        }, 1600);
      }
    }

    // Function to show lake details
    function showLakeDetails(lakeId) {
      alert('Lake details modal would open here for ' + lakeId);
      // In production, this would open a modal with full lake details
    }

    // Search filter function
    function filterLakes() {
      const searchTerm = document.getElementById('lake-search').value.toLowerCase();
      const lakeItems = document.querySelectorAll('.lake-list-item');

      lakeItems.forEach(item => {
        const lakeName = item.getAttribute('data-lake-name').toLowerCase();
        if (lakeName.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });

      // Reapply filters after search
      applyFilters();
    }

    // Apply filters
    function applyFilters() {
      const searchTerm = document.getElementById('lake-search').value.toLowerCase();
      const condition = document.getElementById('filter-condition').value;
      const barsCount = parseInt(document.getElementById('bars-count').textContent) || 0;
      const hasCasino = document.getElementById('filter-casino').checked;
      const hasBaitShop = document.getElementById('filter-baitshop').checked;
      const hasIceHouse = document.getElementById('filter-icehouse').checked;
      const hasLodging = document.getElementById('filter-lodging').checked;
      const hasRestaurant = document.getElementById('filter-restaurant').checked;
      const hasBoatLaunch = document.getElementById('filter-boatlaunch').checked;
      const hasGasStation = document.getElementById('filter-gasstation').checked;
      const hasGrocery = document.getElementById('filter-grocery').checked;
      const hasGuideService = document.getElementById('filter-guideservice').checked;

      const lakeItems = document.querySelectorAll('.lake-list-item');
      let visibleCount = 0;

      lakeItems.forEach(item => {
        const lakeName = item.getAttribute('data-lake-name').toLowerCase();
        const itemThickness = parseInt(item.getAttribute('data-thickness')) || 0;
        const itemBars = parseInt(item.getAttribute('data-bars'));
        const itemCasino = item.getAttribute('data-casino') === 'true';
        const itemBaitShop = item.getAttribute('data-baitshop') === 'true';
        const itemIceHouse = item.getAttribute('data-icehouse') === 'true';
        const itemLodging = item.getAttribute('data-lodging') === 'true';
        const itemRestaurant = item.getAttribute('data-restaurant') === 'true';
        const itemBoatLaunch = item.getAttribute('data-boatlaunch') === 'true';
        const itemGasStation = item.getAttribute('data-gasstation') === 'true';
        const itemGrocery = item.getAttribute('data-grocery') === 'true';
        const itemGuideService = item.getAttribute('data-guideservice') === 'true';

        let show = true;

        // Search filter
        if (searchTerm && !lakeName.includes(searchTerm)) {
          show = false;
        }

        // Ice thickness filter (X or more inches)
        if (condition && itemThickness < parseInt(condition)) {
          show = false;
        }

        // Bars filter (X or more)
        if (barsCount > 0 && itemBars < barsCount) {
          show = false;
        }

        // Casino filter
        if (hasCasino && !itemCasino) {
          show = false;
        }

        // Bait Shop filter
        if (hasBaitShop && !itemBaitShop) {
          show = false;
        }

        // Ice House filter
        if (hasIceHouse && !itemIceHouse) {
          show = false;
        }

        // Lodging filter
        if (hasLodging && !itemLodging) {
          show = false;
        }

        // Restaurant filter
        if (hasRestaurant && !itemRestaurant) {
          show = false;
        }

        // Boat Launch filter
        if (hasBoatLaunch && !itemBoatLaunch) {
          show = false;
        }

        // Gas Station filter
        if (hasGasStation && !itemGasStation) {
          show = false;
        }

        // Grocery filter
        if (hasGrocery && !itemGrocery) {
          show = false;
        }

        // Guide Service filter
        if (hasGuideService && !itemGuideService) {
          show = false;
        }

        item.style.display = show ? 'block' : 'none';
        if (show) visibleCount++;
      });

      // Filter map markers
      lakes.forEach(lake => {
        let show = true;

        // Search filter
        if (searchTerm && !lake.name.toLowerCase().includes(searchTerm)) {
          show = false;
        }

        // Ice thickness filter (X or more inches)
        if (condition && lake.thickness < parseInt(condition)) {
          show = false;
        }

        // Bars filter (X or more)
        if (barsCount > 0 && lake.bars < barsCount) {
          show = false;
        }

        // Casino filter
        if (hasCasino && !lake.casino) {
          show = false;
        }

        // Bait Shop filter
        if (hasBaitShop && !lake.baitshop) {
          show = false;
        }

        // Ice House filter
        if (hasIceHouse && !lake.icehouse) {
          show = false;
        }

        // Lodging filter
        if (hasLodging && !lake.lodging) {
          show = false;
        }

        // Restaurant filter
        if (hasRestaurant && !lake.restaurant) {
          show = false;
        }

        // Boat Launch filter
        if (hasBoatLaunch && !lake.boatlaunch) {
          show = false;
        }

        // Gas Station filter
        if (hasGasStation && !lake.gasstation) {
          show = false;
        }

        // Grocery filter
        if (hasGrocery && !lake.grocery) {
          show = false;
        }

        // Guide Service filter
        if (hasGuideService && !lake.guideservice) {
          show = false;
        }

        // Show/hide marker
        if (lake.marker) {
          if (show) {
            map.addLayer(lake.marker);
          } else {
            map.removeLayer(lake.marker);
          }
        }
      });

      // Sort lakes alphabetically after filtering
      sortLakesAlphabetically();

      updateFilterCount();
    }

    // Update filter count badge
    function updateFilterCount() {
      const condition = document.getElementById('filter-condition').value;
      const barsCount = parseInt(document.getElementById('bars-count').textContent) || 0;
      const hasCasino = document.getElementById('filter-casino').checked;
      const hasBaitShop = document.getElementById('filter-baitshop').checked;
      const hasIceHouse = document.getElementById('filter-icehouse').checked;
      const hasLodging = document.getElementById('filter-lodging').checked;
      const hasRestaurant = document.getElementById('filter-restaurant').checked;
      const hasBoatLaunch = document.getElementById('filter-boatlaunch').checked;
      const hasGasStation = document.getElementById('filter-gasstation').checked;
      const hasGrocery = document.getElementById('filter-grocery').checked;
      const hasGuideService = document.getElementById('filter-guideservice').checked;

      let count = 0;
      if (condition) count++;
      if (barsCount > 0) count++;
      if (hasCasino) count++;
      if (hasBaitShop) count++;
      if (hasIceHouse) count++;
      if (hasLodging) count++;
      if (hasRestaurant) count++;
      if (hasBoatLaunch) count++;
      if (hasGasStation) count++;
      if (hasGrocery) count++;
      if (hasGuideService) count++;

      const badge = document.getElementById('filter-count');
      if (count > 0) {
        badge.textContent = count + ' active';
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // Clear all filters
    function clearFilters() {
      document.getElementById('filter-condition').value = '';
      document.getElementById('lake-search').value = '';

      // Reset bar counter
      document.getElementById('bars-count').textContent = '0';
      document.getElementById('bars-label').classList.add('hidden');
      document.getElementById('bars-minus').disabled = true;

      // Uncheck all amenity filters
      document.getElementById('filter-casino').checked = false;
      document.getElementById('filter-baitshop').checked = false;
      document.getElementById('filter-icehouse').checked = false;
      document.getElementById('filter-lodging').checked = false;
      document.getElementById('filter-restaurant').checked = false;
      document.getElementById('filter-boatlaunch').checked = false;
      document.getElementById('filter-gasstation').checked = false;
      document.getElementById('filter-grocery').checked = false;
      document.getElementById('filter-guideservice').checked = false;

      // Show all lakes
      document.querySelectorAll('.lake-list-item').forEach(item => {
        item.style.display = 'block';
      });

      // Show all lake markers
      lakes.forEach(lake => {
        if (lake.marker) {
          map.addLayer(lake.marker);
        }
      });

      updateFilterCount();
    }

    // Sort lakes alphabetically
    function sortLakesAlphabetically() {
      const container = document.getElementById('lakes-list');
      const items = Array.from(container.querySelectorAll('.lake-list-item'));
      items.sort((a, b) => {
        const nameA = a.getAttribute('data-lake-name').toLowerCase();
        const nameB = b.getAttribute('data-lake-name').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      items.forEach(item => container.appendChild(item));
    }

    // Sort on page load
    sortLakesAlphabetically();
  </script>
</body>
</html>
